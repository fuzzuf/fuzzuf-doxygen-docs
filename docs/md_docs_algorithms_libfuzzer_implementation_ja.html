<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>fuzzuf: fuzzufでのlibFuzzerの実装</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">fuzzuf
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">fuzzufでのlibFuzzerの実装 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>ここではfuzzufでのlibFuzzerの実装について解説する。</p>
<h1><a class="anchor" id="autotoc_md125"></a>
標準的なlibFuzzerの組み方</h1>
<p>オリジナルのlibFuzzerの<code>Fuzzer::Loop()</code>に相当するファザーは<a href="/include/fuzzuf/algorithms/libfuzzer/create.hpp">include/fuzzuf/algorithms/libfuzzer/create.hpp</a>の<code><a class="el" href="namespacefuzzuf_1_1algorithm_1_1libfuzzer.html#a82fd8119ac5d70a0ea83b57effd67a1e">createRunone()</a></code>として実装されている。標準的なlibFuzzerとして使う場合にはこの関数を利用することでfuzzufでのlibFuzzer実装が利用できる。</p>
<h1><a class="anchor" id="autotoc_md126"></a>
libFuzzerを構成するHierarFlowノード</h1>
<p>HierarFlowでlibFuzzerを表現するために以下のようなノードを実装している。それぞれのノードについての詳細についてはソースコードのコメントやDoxygenで生成されたドキュメントを参照してもらいたい。</p>
<h2><a class="anchor" id="autotoc_md127"></a>
Mutatorノード</h2>
<ul>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/erase_bytes.hpp">EraseBytes</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/insert_byte.hpp">InsertByte</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/insert_repeated_bytes.hpp">InsertRepeatedBytes</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/change_byte.hpp">ChangeByte</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/change_bit.hpp">ChangeBit</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/shuffle_bytes.hpp">ShuffleBytes</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/change_ascii_integer.hpp">ChangeASCIIInteger</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/change_binary_integer.hpp">ChangeBinaryInteger</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/copy_part.hpp">CopyPart</a><ul>
<li>CopyPartOf</li>
<li>InsertPartOf</li>
</ul>
</li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/crossover.hpp">CrossOver</a><ul>
<li>CrossOver</li>
<li>CopyPartOf</li>
<li>InsertPartOf</li>
</ul>
</li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/mutation/dictionary.hpp">Dictionary</a><ul>
<li>Dictionary</li>
<li><a class="el" href="classUpdateDictionary.html" title="Add dictionary history entries to the dictionary specified by the Path. libFuzzer has &quot;Parsistent Aut...">UpdateDictionary</a></li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md128"></a>
制御ノード</h2>
<p>制御ノードはHierarFlowでlibFuzzerを構成するために必要な制御を行うノードである。</p>
<ul>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/for_each.hpp">ForEach</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/if_new_coverage.hpp">IfNewCoverage</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/random_call.hpp">RandomCall</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/repeat.hpp">Repeat</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/repeat_until_new_coverage.hpp">RepeatUntilNewCoverage</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/repeat_until_mutated.hpp">RepeatUntilMutated</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/do_nothing.hpp">DoNothing</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/assign.hpp">Assign</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/append.hpp">Append</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md129"></a>
Executeノード</h2>
<p>ExecuteノードはfuzzufのExecutorを持ち、ターゲットを入力値を使って実行し、カバレッジと標準出力、実行結果を取得するノードである。</p>
<ul>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/execute.hpp">Execute</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md130"></a>
Feedbackノード</h2>
<p>Feedbackノードは実行結果をcorpusに追加するかどうかの判断するノードを実際に追加するノードから構成される。</p>
<ul>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/collect_features.hpp">CollectFeatures</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/add_to_corpus.hpp">AddToCorpus</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/add_to_solution.hpp">AddToSolutions</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/add_to_solution.hpp">UpdateDistribution</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/choose_random_seed.hpp">ChooseRandomSeed</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md131"></a>
デバッグノード</h2>
<p>デバッグノードはHierarFlowで構成したファザーのデバッグのために利用可能なノードである。</p>
<ul>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/dump.hpp">Dump</a></li>
<li><a href="/include/fuzzuf/algorithms/libfuzzer/hierarflow/print_status_for_new_unit.hpp">PrintStatusForNewUnit</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md132"></a>
未実装部分</h1>
<p>いくつかのlibFuzzerの機能はfuzzufでは実装されていない:</p>
<h2><a class="anchor" id="autotoc_md133"></a>
Mutator</h2>
<h3><a class="anchor" id="autotoc_md134"></a>
Mutate_AddWordFromTORC (CMP)</h3>
<p>オプションCMPが有効な場合に追加されるmutatorであり、比較演算で分岐したときの情報を記録してmutationを行う。この機能を使うにはまず<code>-fsanitize-coverage=trace-cmp</code>を使って比較演算で分岐した際に何と何を何の演算子で比較したかを記録する。CMPは比較に使われた値と同じ値を入力から探し、それを条件分岐が異なる側に入るように書き換える。入力に比較したのと同じ値が入っていたからと言って、それが必ずしも比較された値そのものとは限らないが、ある程度の確率で分岐方向を変えられる事を期待する。 fuzzufでは<code>trace-cmp</code>で得られる比較演算の情報が取得できないためこのmutatorは使えない。</p>
<h2><a class="anchor" id="autotoc_md135"></a>
Mutate_AddWordFromPersistentAutoDictionary</h2>
<p>過去に<code>Mutate_AddWordFromManualDictionary</code>と<code>Mutate_AddWordFromTORC</code>で挿入した値のうち、新しいカバレッジの発見に繋がった物が蓄積される辞書の実装であるが、fuzzufではCMPが実装されていないため、<code>Mutate_AddWordFromManualDictionary</code>のみから入力を拾う実装になっている。</p>
<h3><a class="anchor" id="autotoc_md136"></a>
カスタムmutator</h3>
<p>libFuzzerには独自のmutatorを追加する為にCustomMutatorとCustomCrossOverが用意されている。fuzzufでは特別なノードを用意するよりノードを自作して追加する方が簡単な為、これらのmutatorに対応するノードは用意していない。</p>
<h2><a class="anchor" id="autotoc_md137"></a>
Corpus</h2>
<p>libFuzzerはCorpusの完全な状態を永続化し、途中からfuzzingを再開する事ができるが、fuzzufの実装では入力値のみを永続化するため、永続化された情報から再開したとしても以前の状態を完全に復元する事はできない。</p>
<h2><a class="anchor" id="autotoc_md138"></a>
Feature</h2>
<h3><a class="anchor" id="autotoc_md139"></a>
Data Flow Trace</h3>
<p>Data Flow TraceではLLVMのDataFlowSanitizerを使って得られるデータの移動の記録を使って入力値のどの部分が分岐に影響するかを特定する。この結果に基づいてmutationを行う範囲にマスクをかける事で、特定の分岐を抜ける入力を集中的に探すと考えられる。しかし、オリジナルのlibFuzzerの実装ではマスクの生成には繋がっておらず、この情報は有効に活用されていない。fuzzufではCMPが未実装である理由と同様に、DataFlowSanitizerに相当する情報を得る手段がないため未実装となっている。</p>
<h2><a class="anchor" id="autotoc_md140"></a>
Executor</h2>
<h3><a class="anchor" id="autotoc_md141"></a>
子プロセス作成の回避</h3>
<p>libFuzzerはfuzzingの対象とfuzzerを同じバイナリにリンクする事で子プロセス生成のコストを回避するが、これに相当するexecutorは現状fuzzufにない為、fuzzufの実装では子プロセスが作られる。</p>
<h3><a class="anchor" id="autotoc_md142"></a>
共有ライブラリのサポート</h3>
<p>libFuzzerは実行可能バイナリのedge coverageだけでなく、そこにリンクされる共有ライブラリのedge coverageも回収して結合する仕組みを持っている。fuzzufは共有ライブラリからカバレッジを取る手段がないため未実装となっている。</p>
<h2><a class="anchor" id="autotoc_md143"></a>
Feedback</h2>
<h3><a class="anchor" id="autotoc_md144"></a>
Leak Sanitizer</h3>
<p>オリジナルのlibFuzzerはターゲットの実行を開始してから確保され、終了するまでに解放されなかったメモリを検知している。一方、fuzzufではLeak Sanitizer付きでターゲットがコンパイルされていればこのケースを失敗扱いにすることはできるが、失敗理由はabortになるため、メモリリークだったかどうか判別できないため、未解放のメモリ検知の情報を活用できない。</p>
<h3><a class="anchor" id="autotoc_md145"></a>
Stack Depth Tracing</h3>
<p>オリジナルのlibFuzzerではLLVMのSanitizerCoverageのstack-depthを使ってターゲットがスタックをどこまで使ったかを取得するが、fuzzufでは使われたスタックの深さを取る手段がないため、未実装となっている。 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
