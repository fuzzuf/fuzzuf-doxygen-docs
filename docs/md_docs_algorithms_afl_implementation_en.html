<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>fuzzuf: AFL Implementation in fuzzuf</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">fuzzuf
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">AFL Implementation in fuzzuf </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md21"></a>
Reference AFL Implementation</h1>
<ul>
<li>Version: 2.57b</li>
<li>Commit: <a href="https://github.com/google/AFL/commit/fab1ca5ed7e3552833a18fc2116d33a9241699bc">fab1ca5ed7e3552833a18fc2116d33a9241699bc</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md22"></a>
Directory Layout</h1>
<p>In fuzzuf, implementations of AFL are located in <a href="/include/fuzzuf/algorithms/afl">include/fuzzuf/algorithms/afl</a> and <a href="/algorithms/afl">algorithms/afl</a>. Because AFL has many derived algorithms, we implemented most of the classes by templates. Therefore, the declarations and definitions of those classes are in the header files under <a href="/include/fuzzuf/algorithms/afl">include/fuzzuf/algorithms/afl</a>.</p>
<p>These template classes are declared in <a href="/include/fuzzuf/algorithms/afl">include/fuzzuf/algorithms/afl</a> and defined in <a href="/include/fuzzuf/algorithms/afl/templates">include/fuzzuf/algorithms/afl/templates</a>. This directory layout is due to historical reasons and not due to the coding conventions of fuzzuf; it was designed to reduce the difference of changes when the AFL implementation was reconstructed as template classes to improve reusability. We consider removing the <code>templates</code> subdirectory and merging the files in future refactorings.</p>
<h1><a class="anchor" id="autotoc_md23"></a>
AFL in HierarFlow</h1>
<p>AFL is represented in HierarFlow as in <a href="/include/fuzzuf/algorithms/afl/templates/afl_fuzzer.hpp">include/fuzzuf/algorithms/afl/templates/afl_fuzzer.hpp</a>:</p>
<div class="fragment"><div class="line">fuzz_loop &lt;&lt; (</div>
<div class="line">     cull_queue</div>
<div class="line">  || select_seed</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line">select_seed &lt;&lt; (</div>
<div class="line">     consider_skip_mut</div>
<div class="line">  || retry_calibrate</div>
<div class="line">  || trim_case</div>
<div class="line">  || calc_score</div>
<div class="line">  || apply_det_muts &lt;&lt; (</div>
<div class="line">         bit_flip1 &lt;&lt; execute &lt;&lt; (normal_update || construct_auto_dict)</div>
<div class="line">      || bit_flip_other &lt;&lt; execute.HardLink() &lt;&lt; normal_update.HardLink()</div>
<div class="line">      || byte_flip1 &lt;&lt; execute.HardLink() &lt;&lt; (normal_update.HardLink()</div>
<div class="line">                                           || construct_eff_map)</div>
<div class="line">      || byte_flip_other &lt;&lt; execute.HardLink() &lt;&lt; normal_update.HardLink()</div>
<div class="line">      || arith &lt;&lt; execute.HardLink() &lt;&lt; normal_update.HardLink()</div>
<div class="line">      || interest &lt;&lt; execute.HardLink() &lt;&lt; normal_update.HardLink()</div>
<div class="line">      || user_dict_overwrite &lt;&lt; execute.HardLink() &lt;&lt; normal_update.HardLink()</div>
<div class="line">      || auto_dict_overwrite &lt;&lt; execute.HardLink() &lt;&lt; normal_update.HardLink()</div>
<div class="line">     )</div>
<div class="line">   || apply_rand_muts &lt;&lt; (</div>
<div class="line">           havoc &lt;&lt; execute.HardLink() &lt;&lt; normal_update.HardLink()</div>
<div class="line">        || splicing &lt;&lt; execute.HardLink() &lt;&lt; normal_update.HardLink()</div>
<div class="line">      )</div>
<div class="line">   || abandon_node</div>
<div class="line">);</div>
</div><!-- fragment --><p>The following code implements the routines for each node:</p>
<ul>
<li>Mutation node routines (e.g. <code>bit_flip1</code> and <code>bit_flip_other</code>):<ul>
<li><a href="/include/fuzzuf/algorithms/afl/afl_mutation_hierarflow_routines.hpp">include/fuzzuf/algorithms/afl/afl_mutation_hierarflow_routines.hpp</a></li>
</ul>
</li>
<li>Update node routines (e.g. <code>normal_update</code> and <code>construct_auto_dict</code>):<ul>
<li><a href="/include/fuzzuf/algorithms/afl/afl_update_hierarflow_routines.hpp">include/fuzzuf/algorithms/afl/afl_update_hierarflow_routines.hpp</a></li>
</ul>
</li>
<li>Other node routines:<ul>
<li><a href="/include/fuzzuf/algorithms/afl/afl_other_hierarflow_routines.hpp">include/fuzzuf/algorithms/afl/afl_other_hierarflow_routines.hpp</a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md24"></a>
Consistency</h1>
<p>The AFL of fuzzuf has been confirmed to be identical in behavior to the original implementation, which means that it is fully consistent. For more details on consistency testing, please check the following repository:</p>
<ul>
<li><a href="https://github.com/fuzzuf/fuzzuf-afl-artifact">https://github.com/fuzzuf/fuzzuf-afl-artifact</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md25"></a>
Changes after Consistency Test</h2>
<p>The current implementation has changed significantly from the implementation at the time of the consistency check. One of the most notable changes is the customizable design of the mutation havoc to facilitate the implementation of AFL-derived algorithms. As a result, the current AFL on fuzzuf does not produce the same results as the original AFL.</p>
<p>However, since there is no difference in the mutations themselves, and the probability of each type of mutation being selected in havoc should be the same as in the original AFL, the statistical behavior should not have changed at all.</p>
<h1><a class="anchor" id="autotoc_md26"></a>
How to Implement an AFL Derived Algorithm</h1>
<p>Many users may want to use fuzzuf to implement AFL-derived algorithms. Here is a quick overview of how to implement an AFL-derived algorithm. Please refer to AFLFast Implementation for the detailed implementation.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
1. Define a Tag</h2>
<p>First of all, define an empty structure called Tag for the derived algorithm you want to create (e.g., <code>struct AFLDerivedTag {};</code>). For example, the Tag for AFL is defined in <a href="/include/fuzzuf/algorithms/afl/afl_option.hpp">include/fuzzuf/algorithms/afl/afl_option.hpp</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>AFLTag {};</div>
</div><!-- fragment --><p>In fuzzuf, Tag allows you to arbitrarily change the value of a constant. See the comments in <a href="/include/fuzzuf/algorithms/afl/afl_option.hpp">include/fuzzuf/algorithms/afl/afl_option.hpp</a> for details.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
2. Inherit AFLTestcase</h2>
<p>If you want a seed to have its information in addition to what AFL has, define a new Testcase class that inherits from <code>AFLTestcase</code> (e.g. <code>AFLDerivedTestcase</code>). You should declare <code>AFLDerivedTestcase::Tag</code> using an alias declaration with <code>using</code>. For example, the code can look like this:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>AFLDerivedTestcase : <span class="keyword">public</span> AFLTestcase {</div>
<div class="line">  <span class="keyword">using</span> Tag = AFLDerivedTag;</div>
<div class="line"> </div>
<div class="line">  ...</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md29"></a>
3. Inherit AFLState</h2>
<p>If you want additional information in the whole algorithm, define a new State class that inherits from <code>AFLState</code> (e.g. <code>AFLDerivedState</code>).</p>
<h2><a class="anchor" id="autotoc_md30"></a>
4. Specialize AFLState Member Functions and/or Add a HierarFlowRoutine</h2>
<p>If the derived algorithm has the same algorithm flow as AFL but needs to be handled differently, use member function overrides or template class specialization.</p>
<p>Alternatively, if the derived algorithm has a different algorithm flow from AFL, define a <a class="el" href="classHierarFlowRoutine.html">HierarFlowRoutine</a> that corresponds to the processing. In this case, define <code>AFLFuzzerTemplate&lt;AFLDerivedState&gt;::BuildFuzzFlow</code> and describe the algorithm flow. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
